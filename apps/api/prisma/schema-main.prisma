// Main Database Schema
// Contains authentication, authorization, and tenant registry
//
// This database is shared across all tenants and handles:
// - User accounts and authentication
// - Roles and capabilities (RBAC)
// - Tenant registry and database routing
// - Refresh tokens for JWT

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma-main"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String            @id @default(uuid())
  email                      String            @unique
  passwordHash               String?           @map("password_hash")
  name                       String
  tenantId                   String?           @map("tenant_id")
  tenant                     Tenant?           @relation(fields: [tenantId], references: [id])
  roles                      UserRole[]
  refreshTokens              RefreshToken[]
  loginAttempts              LoginAttempt[]
  accountLockouts            AccountLockout[]
  googleId                   String?           @unique @map("google_id")
  twoFactorEnabled           Boolean           @default(false) @map("two_factor_enabled")
  twoFactorSecret            String?           @map("two_factor_secret")
  twoFactorGracePeriodEndsAt DateTime?         @map("two_factor_grace_period_ends_at")
  isActive                   Boolean           @default(true) @map("is_active")
  isSeeded                   Boolean           @default(false) @map("is_seeded")
  requirePasswordChange      Boolean           @default(false) @map("require_password_change")
  lastLoginAt                DateTime?         @map("last_login_at")
  communicationMedium        String?           @default("email") @map("communication_medium") // email, sms, both, none
  notificationFrequency      String?           @default("immediate") @map("notification_frequency") // immediate, hourly, daily, weekly
  secondaryEmail             String?           @map("secondary_email")
  compensationType           CompensationType? @map("compensation_type")
  hourlyRate                 Decimal?          @map("hourly_rate") @db.Decimal(10, 2)
  trackingMode               TrackingMode      @default(CLOCK) @map("tracking_mode") // clock or time (manual entry)
  createdAt                  DateTime          @default(now()) @map("created_at")
  updatedAt                  DateTime          @updatedAt @map("updated_at")
  deletedAt                  DateTime?         @map("deleted_at")

  @@index([email])
  @@index([tenantId])
  @@index([googleId])
  @@map("users")
}

model Tenant {
  id           String  @id @default(uuid())
  name         String
  slug         String  @unique
  tenantKey    String  @unique @map("tenant_key") // Unique short key for tenant authentication (e.g., TENANT-1234)
  databaseId   String? @unique @map("database_id") // UUID4 for database identification
  databaseName String? @unique @map("database_name") // Database for this tenant's data
  databaseHost String  @default("localhost") @map("database_host")
  isActive     Boolean @default(true) @map("is_active")
  isSeeded     Boolean @default(false) @map("is_seeded") // Track if created by seed script

  // Contact Information
  contactName  String? @map("contact_name")
  contactEmail String? @map("contact_email")
  contactPhone String? @map("contact_phone")

  // Billing Address
  billingStreet  String? @map("billing_street")
  billingCity    String? @map("billing_city")
  billingState   String? @map("billing_state")
  billingZip     String? @map("billing_zip")
  billingCountry String? @map("billing_country")
  billingEmail   String? @map("billing_email") // If different from contact email

  users            User[]
  securitySettings SecuritySettings[]
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")

  @@index([slug])
  @@index([tenantKey])
  @@index([databaseId])
  @@index([databaseName])
  @@index([contactEmail])
  @@map("tenants")
}

model Role {
  id           String           @id @default(uuid())
  name         String           @unique
  description  String?
  isSeeded     Boolean          @default(false) @map("is_seeded")
  users        UserRole[]
  capabilities RoleCapability[]
  createdAt    DateTime         @default(now()) @map("created_at")

  @@map("roles")
}

model Capability {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  isSeeded    Boolean          @default(false) @map("is_seeded")
  roles       RoleCapability[]
  createdAt   DateTime         @default(now()) @map("created_at")

  @@map("capabilities")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  isSeeded  Boolean  @default(false) @map("is_seeded")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model RoleCapability {
  id           String     @id @default(uuid())
  roleId       String     @map("role_id")
  capabilityId String     @map("capability_id")
  isAllowed    Boolean    @default(true) @map("is_allowed")
  isSeeded     Boolean    @default(false) @map("is_seeded")
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  capability   Capability @relation(fields: [capabilityId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now()) @map("created_at")

  @@unique([roleId, capabilityId])
  @@index([roleId])
  @@index([capabilityId])
  @@map("role_capabilities")
}

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String   @unique
  familyId   String   @map("family_id")
  isRevoked  Boolean  @default(false) @map("is_revoked")
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  deviceInfo String?  @map("device_info")

  @@index([userId])
  @@index([token])
  @@index([familyId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model ImpersonationSession {
  id           String    @id @default(uuid())
  adminUserId  String    @map("admin_user_id")
  targetUserId String    @map("target_user_id")
  startedAt    DateTime  @default(now()) @map("started_at")
  endedAt      DateTime? @map("ended_at")
  reason       String?
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")

  @@index([adminUserId])
  @@index([targetUserId])
  @@index([startedAt])
  @@map("impersonation_sessions")
}

enum CompensationType {
  SALARY_HCE // Highly Compensated Employee - no overtime
  SALARY_WITH_OT // Salary with overtime after 40 hours
  HOURLY // Hourly employee with overtime after 40 hours
}

enum TrackingMode {
  CLOCK // User can only use time clock (punch in/out)
  TIME // User can only enter manual time entries
  BOTH // User can use both clock and manual time entries
}

enum AttemptType {
  PASSWORD
  TWO_FACTOR
}

model SecuritySettings {
  id                            String   @id @default(uuid())
  tenantId                      String   @unique @map("tenant_id")
  tenant                        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  twoFactorGracePeriodDays      Int      @default(10) @map("two_factor_grace_period_days")
  twoFactorRequiredRoles        String[] @map("two_factor_required_roles")
  twoFactorBypassUrls           String[] @map("two_factor_bypass_urls")
  maxPasswordAttempts           Int      @default(5) @map("max_password_attempts")
  maxTwoFactorAttempts          Int      @default(3) @map("max_two_factor_attempts")
  accountLockoutDurationMinutes Int      @default(30) @map("account_lockout_duration_minutes")
  createdAt                     DateTime @default(now()) @map("created_at")
  updatedAt                     DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("security_settings")
}

model LoginAttempt {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  attemptType AttemptType @map("attempt_type")
  success     Boolean
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")
  createdAt   DateTime    @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@index([userId, attemptType, createdAt])
  @@map("login_attempts")
}

model AccountLockout {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lockedAt    DateTime  @default(now()) @map("locked_at")
  lockedUntil DateTime  @map("locked_until")
  reason      String
  unlocked    Boolean   @default(false)
  unlockedAt  DateTime? @map("unlocked_at")
  unlockedBy  String?   @map("unlocked_by") // Admin user ID who manually unlocked

  @@index([userId])
  @@index([lockedUntil])
  @@index([userId, unlocked])
  @@map("account_lockouts")
}

model SystemSettings {
  id                         String   @id @default("system") // Singleton table
  bypassTwoFactorForAllUsers Boolean  @default(false) @map("bypass_two_factor_for_all_users")
  createdAt                  DateTime @default(now()) @map("created_at")
  updatedAt                  DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model PayPalIntegration {
  id               String   @id @default(uuid())
  name             String // Friendly name for this PayPal integration
  clientId         String   @map("client_id") // PayPal REST API Client ID
  clientSecretEnc  String   @map("client_secret_enc") // Encrypted PayPal REST API Secret
  isProduction     Boolean  @default(false) @map("is_production") // true = live, false = sandbox
  isActive         Boolean  @default(true) @map("is_active")
  allowedTenantIds String[] @default([]) @map("allowed_tenant_ids") // Empty array = all tenants, else specific list
  webhookId        String?  @map("webhook_id") // PayPal webhook ID for events
  createdBy        String   @map("created_by") // Admin user ID
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([isProduction])
  @@map("paypal_integrations")
}

model IntegrationTemplate {
  id                   String              @id @default(uuid())
  name                 String // Display name (e.g., "OpenAI GPT-4", "SendGrid Email")
  slug                 String              @unique // URL-friendly identifier (e.g., "openai-gpt4", "sendgrid")
  category             IntegrationCategory // Category/type of integration
  description          String? // Description of what this integration does
  provider             String // Provider name (e.g., "OpenAI", "SendGrid", "Pinecone")
  iconUrl              String?             @map("icon_url") // URL to integration icon/logo
  documentationUrl     String?             @map("documentation_url") // Link to integration docs
  configSchema         Json                @map("config_schema") // JSON schema defining required config fields
  defaultConfig        Json?               @map("default_config") // Default configuration values
  requiredCapabilities String[]            @default([]) @map("required_capabilities") // Required user capabilities to use this template
  isActive             Boolean             @default(true) @map("is_active") // Whether this template is available
  isSeeded             Boolean             @default(false) @map("is_seeded") // System-provided template
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")
  deletedAt            DateTime?           @map("deleted_at")

  @@index([category])
  @@index([isActive])
  @@index([slug])
  @@map("integration_templates")
}

enum IntegrationCategory {
  AI // AI/LLM integrations (OpenAI, Anthropic, etc.)
  EMAIL // Email services (SendGrid, Mailgun, etc.)
  VECTOR_DB // Vector databases (Pinecone, Weaviate, etc.)
  PAYMENT // Payment processors (PayPal, Stripe, etc.)
  MONITORING // Monitoring and error tracking (Sentry, DataDog, etc.)
  STORAGE // Cloud storage (S3, Azure Blob, etc.)
  COMMUNICATION // Communication platforms (Slack, Discord, etc.)
  ANALYTICS // Analytics platforms (Google Analytics, Mixpanel, etc.)
  OTHER // Other integrations

  @@map("integration_category")
}

// Account Request - Stores account access requests from potential users
model AccountRequest {
  id              String               @id @default(uuid())
  fullName        String               @map("full_name")
  email           String               @map("email")
  companyName     String               @map("company_name")
  jobTitle        String               @map("job_title")
  phone           String?              @map("phone")
  reasonForAccess String               @map("reason_for_access") @db.Text
  howHeardAboutUs String?              @map("how_heard_about_us")
  ipAddress       String?              @map("ip_address") // For spam prevention tracking
  userAgent       String?              @map("user_agent") @db.Text // Browser info for spam detection
  status          AccountRequestStatus @default(PENDING)
  reviewedBy      String?              @map("reviewed_by") // Admin user ID who reviewed
  reviewedAt      DateTime?            @map("reviewed_at")
  reviewNotes     String?              @map("review_notes") @db.Text
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("account_requests")
}

enum AccountRequestStatus {
  PENDING
  APPROVED
  REJECTED
  SPAM

  @@map("account_request_status")
}

// Conversation - Chat conversations (for admin users without tenants)
model Conversation {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  title     String?
  isActive  Boolean   @default(true) @map("is_active")
  messages  Message[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([isActive])
  @@map("conversations")
}

// Message - Chat messages (for admin users without tenants)
model Message {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           MessageRole
  content        String       @db.Text
  metadata       Json?
  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([conversationId])
  @@map("messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM

  @@map("message_role")
}

// LLM Configuration - System-wide LLM settings (admin only)
model LLMConfig {
  id              String      @id @default(uuid())
  provider        LLMProvider
  apiKeyEncrypted String      @map("api_key_encrypted") // Encrypted API key
  defaultModel    String      @map("default_model")
  temperature     Decimal     @default(0.7) @db.Decimal(3, 2) // 0.00-1.00
  maxTokens       Int         @default(2000) @map("max_tokens")
  baseUrl         String?     @map("base_url") // Custom API endpoint (optional)
  organization    String?     @map("organization") // Organization ID (OpenAI only)
  timeout         Int         @default(30000) // Request timeout in milliseconds
  isActive        Boolean     @default(true) @map("is_active")
  tenantId        String?     @map("tenant_id") // null = system-wide, UUID = tenant-specific
  createdBy       String      @map("created_by") // Admin user ID who created this config
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([tenantId])
  @@index([provider])
  @@map("llm_configs")
}

enum LLMProvider {
  OPENAI        @map("openai")
  ANTHROPIC     @map("anthropic")
  GOOGLE_GEMINI @map("google-gemini")
  PERPLEXITY    @map("perplexity")
  ABACUS_AI     @map("abacus-ai")

  @@map("llm_provider")
}
