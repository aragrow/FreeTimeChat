// Client Database Schema
// Each customer has their own database with this schema
//
// This database contains customer-specific data:
// - Clients (the customer's clients)
// - Projects and time tracking
// - Tasks
// - Chat conversations and messages
//
// Note: userId fields reference users in the main database

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("CLIENT_DATABASE_URL")
}

model Client {
  id                   String    @id @default(uuid())
  name                 String
  slug                 String    @unique
  companyName          String?   @map("company_name")
  isActive             Boolean   @default(true) @map("is_active")
  hourlyRate           Decimal?  @map("hourly_rate") @db.Decimal(10, 2)
  discountPercentage   Decimal?  @default(0) @map("discount_percentage") @db.Decimal(5, 2)
  // Contact Information
  email                String?
  phone                String?
  website              String?
  contactPerson        String?   @map("contact_person")
  // Billing Address
  billingAddressLine1  String?   @map("billing_address_line1")
  billingAddressLine2  String?   @map("billing_address_line2")
  billingCity          String?   @map("billing_city")
  billingState         String?   @map("billing_state")
  billingPostalCode    String?   @map("billing_postal_code")
  billingCountry       String?   @map("billing_country")
  // Billing Contact
  billingContactName   String?   @map("billing_contact_name")
  billingContactEmail  String?   @map("billing_contact_email")
  billingContactPhone  String?   @map("billing_contact_phone")
  // Invoice Numbering
  invoicePrefix        String?   @map("invoice_prefix") // e.g., "INV-", "ABC-"
  invoiceNextNumber    Int       @default(1) @map("invoice_next_number")
  invoiceNumberPadding Int       @default(5) @map("invoice_number_padding") // e.g., 5 = "00001"
  projects             Project[]
  invoices             Invoice[]
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  deletedAt            DateTime? @map("deleted_at")

  @@index([slug])
  @@index([isActive])
  @@map("clients")
}

model Project {
  id                       String          @id @default(uuid())
  name                     String
  description              String?
  clientId                 String?         @map("client_id")
  client                   Client?         @relation(fields: [clientId], references: [id])
  isActive                 Boolean         @default(true) @map("is_active")
  startDate                DateTime?       @map("start_date")
  endDate                  DateTime?       @map("end_date")
  isBillableProject        Boolean         @default(true) @map("is_billable_project")
  defaultBillable          Boolean         @default(true) @map("default_billable")
  // Budget tracking fields
  hourlyRate               Decimal?        @map("hourly_rate") @db.Decimal(10, 2)
  allocatedHours           Decimal?        @map("allocated_hours") @db.Decimal(10, 2)
  additionalHoursAllocated Decimal?        @default(0) @map("additional_hours_allocated") @db.Decimal(10, 2)
  //
  timeEntries              TimeEntry[]
  tasks                    Task[]
  members                  ProjectMember[]
  createdAt                DateTime        @default(now()) @map("created_at")
  updatedAt                DateTime        @updatedAt @map("updated_at")
  deletedAt                DateTime?       @map("deleted_at")

  @@index([clientId])
  @@index([isActive])
  @@map("projects")
}

model ProjectMember {
  id         String   @id @default(uuid())
  projectId  String   @map("project_id")
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId     String   @map("user_id")
  isBillable Boolean? @map("is_billable")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

model TimeEntry {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  projectId     String    @map("project_id")
  project       Project   @relation(fields: [projectId], references: [id])
  description   String?
  startTime     DateTime  @map("start_time")
  endTime       DateTime? @map("end_time")
  duration      Int?
  regularHours  Decimal?  @map("regular_hours") @db.Decimal(10, 2)
  overtimeHours Decimal?  @map("overtime_hours") @db.Decimal(10, 2)
  weekStartDate DateTime? @map("week_start_date")
  isBillable    Boolean   @default(true) @map("is_billable")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  @@index([userId])
  @@index([projectId])
  @@index([startTime])
  @@index([weekStartDate])
  @@map("time_entries")
}

model Task {
  id               String       @id @default(uuid())
  projectId        String       @map("project_id")
  project          Project      @relation(fields: [projectId], references: [id])
  title            String
  description      String?
  status           TaskStatus   @default(TODO)
  priority         TaskPriority @default(MEDIUM)
  assignedToUserId String?      @map("assigned_to_user_id")
  dueDate          DateTime?    @map("due_date")
  completedAt      DateTime?    @map("completed_at")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([status])
  @@index([assignedToUserId])
  @@map("tasks")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Conversation {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  title     String?
  isActive  Boolean   @default(true) @map("is_active")
  messages  Message[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([isActive])
  @@map("conversations")
}

model Message {
  id             String           @id @default(uuid())
  conversationId String           @map("conversation_id")
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           MessageRole
  content        String           @db.Text
  metadata       Json?
  ratings        ResponseRating[]
  createdAt      DateTime         @default(now()) @map("created_at")

  @@index([conversationId])
  @@map("messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// Phase 5: Response Rating System
// Tracks user feedback on preview data and final reports
model ResponseRating {
  id         String      @id @default(uuid())
  messageId  String      @map("message_id")
  message    Message     @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId     String      @map("user_id") // References user in main DB
  ratingType RatingType  @map("rating_type") // 'preview' or 'report'
  rating     RatingValue // BAD, OK, or GOOD
  feedback   String?     @db.Text // Optional user feedback text
  metadata   Json? // Additional context (query, format, etc.)
  createdAt  DateTime    @default(now()) @map("created_at")

  @@index([messageId])
  @@index([userId])
  @@index([ratingType])
  @@index([rating])
  @@map("response_ratings")
}

enum RatingType {
  PREVIEW // Rating for Phase 3 preview data
  REPORT // Rating for Phase 4 formatted report
}

enum RatingValue {
  BAD
  OK
  GOOD
}

model PayPalTenantConfig {
  id                   String   @id @default(uuid())
  paypalIntegrationId  String   @map("paypal_integration_id") // References PayPalIntegration in main DB
  isEnabled            Boolean  @default(false) @map("is_enabled")
  // PayPal invoice settings
  invoiceEmailSubject  String?  @map("invoice_email_subject") // Custom email subject line
  invoiceTermsAndConds String?  @map("invoice_terms_and_conds") @db.Text // Custom terms and conditions
  invoiceNote          String?  @map("invoice_note") @db.Text // Note to appear on invoice
  invoiceMerchantLogo  String?  @map("invoice_merchant_logo") // Logo URL
  // Payment settings
  allowPartialPayment  Boolean  @default(true) @map("allow_partial_payment")
  minimumAmountDue     Decimal? @map("minimum_amount_due") @db.Decimal(10, 2)
  dueInDays            Int      @default(30) @map("due_in_days") // Net 30, Net 60, etc.
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("paypal_tenant_configs")
}

model Invoice {
  id                 String           @id @default(uuid())
  invoiceNumber      String           @unique @map("invoice_number") // e.g., "INV-00001"
  clientId           String?          @map("client_id")
  client             Client?          @relation(fields: [clientId], references: [id])
  status             InvoiceStatus    @default(DRAFT)
  paypalInvoiceId    String?          @unique @map("paypal_invoice_id") // PayPal's invoice ID
  paypalInvoiceUrl   String?          @map("paypal_invoice_url") // PayPal invoice URL for viewing/payment
  // Dates
  issueDate          DateTime         @map("issue_date")
  dueDate            DateTime         @map("due_date")
  paidDate           DateTime?        @map("paid_date")
  // Amounts
  subtotal           Decimal          @db.Decimal(10, 2)
  taxRate            Decimal          @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount          Decimal          @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount     Decimal          @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount        Decimal          @map("total_amount") @db.Decimal(10, 2)
  amountPaid         Decimal          @default(0) @map("amount_paid") @db.Decimal(10, 2)
  amountDue          Decimal          @map("amount_due") @db.Decimal(10, 2)
  // Details
  note               String?          @db.Text
  termsAndConditions String?          @map("terms_and_conditions") @db.Text
  // Metadata
  createdBy          String           @map("created_by") // User ID
  sentBy             String?          @map("sent_by") // User ID who sent the invoice
  sentAt             DateTime?        @map("sent_at")
  items              InvoiceItem[]
  payments           InvoicePayment[]
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  @@index([clientId])
  @@index([status])
  @@index([issueDate])
  @@index([dueDate])
  @@index([paypalInvoiceId])
  @@map("invoices")
}

model InvoiceItem {
  id           String   @id @default(uuid())
  invoiceId    String   @map("invoice_id")
  invoice      Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  projectId    String?  @map("project_id") // Optional reference to project
  description  String   @db.Text
  quantity     Decimal  @db.Decimal(10, 2)
  unitPrice    Decimal  @map("unit_price") @db.Decimal(10, 2)
  amount       Decimal  @db.Decimal(10, 2) // quantity * unitPrice
  // Time entry references (if invoice item is from time entries)
  timeEntryIds String[] @default([]) @map("time_entry_ids") // Array of time entry IDs
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([invoiceId])
  @@index([projectId])
  @@map("invoice_items")
}

model InvoicePayment {
  id              String   @id @default(uuid())
  invoiceId       String   @map("invoice_id")
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  paypalPaymentId String?  @map("paypal_payment_id") // PayPal transaction ID
  amount          Decimal  @db.Decimal(10, 2)
  paymentDate     DateTime @map("payment_date")
  paymentMethod   String?  @map("payment_method") // e.g., "PayPal", "Credit Card", "Check"
  note            String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([invoiceId])
  @@index([paymentDate])
  @@map("invoice_payments")
}

enum InvoiceStatus {
  DRAFT // Not yet sent
  SENT // Sent to client via PayPal
  VIEWED // Client viewed the invoice
  PAID // Fully paid
  PARTIAL_PAID // Partially paid
  CANCELLED // Cancelled
  REFUNDED // Refunded
  OVERDUE // Past due date
}

// LLM Configuration - Tenant-specific LLM settings (tenantadmin)
model LLMConfig {
  id              String      @id @default(uuid())
  provider        LLMProvider
  apiKeyEncrypted String      @map("api_key_encrypted") // Encrypted API key
  defaultModel    String      @map("default_model")
  temperature     Decimal     @default(0.7) @db.Decimal(3, 2) // 0.00-1.00
  maxTokens       Int         @default(2000) @map("max_tokens")
  baseUrl         String?     @map("base_url") // Custom API endpoint (optional)
  organization    String?     @map("organization") // Organization ID (OpenAI only)
  timeout         Int         @default(30000) // Request timeout in milliseconds
  isActive        Boolean     @default(true) @map("is_active")
  createdBy       String      @map("created_by") // User ID who created this config
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([provider])
  @@map("llm_configs")
}

enum LLMProvider {
  OPENAI        @map("openai")
  ANTHROPIC     @map("anthropic")
  GOOGLE_GEMINI @map("google-gemini")
  PERPLEXITY    @map("perplexity")
  ABACUS_AI     @map("abacus-ai")

  @@map("llm_provider")
}
