// Client Database Schema
// Each customer has their own database with this schema
//
// This database contains customer-specific data:
// - Clients (the customer's clients)
// - Projects and time tracking
// - Tasks
// - Chat conversations and messages
//
// Note: userId fields reference users in the main database

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("CLIENT_DATABASE_URL")
}

model Client {
  id                   String    @id @default(uuid())
  name                 String
  slug                 String    @unique
  isActive             Boolean   @default(true) @map("is_active")
  hourlyRate           Decimal?  @map("hourly_rate") @db.Decimal(10, 2)
  discountPercentage   Decimal?  @default(0) @map("discount_percentage") @db.Decimal(5, 2)
  // Contact Information
  email                String?
  phone                String?
  website              String?
  contactPerson        String?   @map("contact_person")
  // Billing Address
  billingAddressLine1  String?   @map("billing_address_line1")
  billingAddressLine2  String?   @map("billing_address_line2")
  billingCity          String?   @map("billing_city")
  billingState         String?   @map("billing_state")
  billingPostalCode    String?   @map("billing_postal_code")
  billingCountry       String?   @map("billing_country")
  // Invoice Numbering
  invoicePrefix        String?   @map("invoice_prefix") // e.g., "INV-", "ABC-"
  invoiceNextNumber    Int       @default(1) @map("invoice_next_number")
  invoiceNumberPadding Int       @default(5) @map("invoice_number_padding") // e.g., 5 = "00001"
  projects             Project[]
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  deletedAt            DateTime? @map("deleted_at")

  @@index([slug])
  @@index([isActive])
  @@map("clients")
}

model Project {
  id                String          @id @default(uuid())
  name              String
  description       String?
  clientId          String          @map("client_id")
  client            Client          @relation(fields: [clientId], references: [id])
  isActive          Boolean         @default(true) @map("is_active")
  startDate         DateTime?       @map("start_date")
  endDate           DateTime?       @map("end_date")
  isBillableProject Boolean         @default(true) @map("is_billable_project")
  defaultBillable   Boolean         @default(true) @map("default_billable")
  timeEntries       TimeEntry[]
  tasks             Task[]
  members           ProjectMember[]
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  deletedAt         DateTime?       @map("deleted_at")

  @@index([clientId])
  @@index([isActive])
  @@map("projects")
}

model ProjectMember {
  id         String   @id @default(uuid())
  projectId  String   @map("project_id")
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId     String   @map("user_id")
  isBillable Boolean? @map("is_billable")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

model TimeEntry {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  projectId     String    @map("project_id")
  project       Project   @relation(fields: [projectId], references: [id])
  description   String?
  startTime     DateTime  @map("start_time")
  endTime       DateTime? @map("end_time")
  duration      Int?
  regularHours  Decimal?  @map("regular_hours") @db.Decimal(10, 2)
  overtimeHours Decimal?  @map("overtime_hours") @db.Decimal(10, 2)
  weekStartDate DateTime? @map("week_start_date")
  isBillable    Boolean   @default(true) @map("is_billable")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  @@index([userId])
  @@index([projectId])
  @@index([startTime])
  @@index([weekStartDate])
  @@map("time_entries")
}

model Task {
  id               String       @id @default(uuid())
  projectId        String       @map("project_id")
  project          Project      @relation(fields: [projectId], references: [id])
  title            String
  description      String?
  status           TaskStatus   @default(TODO)
  priority         TaskPriority @default(MEDIUM)
  assignedToUserId String?      @map("assigned_to_user_id")
  dueDate          DateTime?    @map("due_date")
  completedAt      DateTime?    @map("completed_at")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([status])
  @@index([assignedToUserId])
  @@map("tasks")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Conversation {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  title     String?
  isActive  Boolean   @default(true) @map("is_active")
  messages  Message[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([isActive])
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           MessageRole
  content        String       @db.Text
  metadata       Json?
  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([conversationId])
  @@map("messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}
